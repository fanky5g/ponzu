package editor

import (
	"bytes"

	"github.com/fanky5g/ponzu/internal/views"
	log "github.com/sirupsen/logrus"
)

type SelectClientDataProvider interface {
	RenderClientOptionsProvider(selector string) ([]byte, error)
}

type SelectInitialOptionsProvider interface {
	GetInitialOptions() ([]string, error)
}

// Select returns the []byte of a <select> HTML element plus internal <options> with a label.
// IMPORTANT:
// The `fieldName` argument will cause a panic if it is not exactly the string
// form of the struct field that this editor input is representing
func Select(fieldName string, p interface{}, attrs map[string]string, dataProvider interface{}) []byte {
	value := ""
	fieldVal := ValueFromStructField(fieldName, p, nil)
	var ok bool
	if value, ok = fieldVal.(string); !ok {
		log.Warnf("Expected field value to be string. Got %T", fieldVal)
	}

	var err error
	options := make([]string, 0)
	if dataProvider != nil {
		if initialdataOptionsProvider, ok := dataProvider.(SelectInitialOptionsProvider); ok {
			options, err = initialdataOptionsProvider.GetInitialOptions()
			if err != nil {
				log.Fatalf("Failed to get options for %s: %v", fieldName, err)
			}
		}
	}

	values := make([]string, len(options))
	i := 0
	for _, v := range options {
		values[i] = v
		i = i + 1
	}

	sel := struct {
		Name     string
		Label    string
		Value    string
		Options  []string
		Selector string
	}{
		Label:    attrs["label"],
		Selector: fieldName,
		Name:     fieldName,
		Options:  options,
		Value:    value,
	}

	w := &bytes.Buffer{}
	if err := views.ExecuteTemplate(w, "select.gohtml", sel); err != nil {
		log.Fatalf("Failed to render select: %v", err)
	}

	return w.Bytes()
}
